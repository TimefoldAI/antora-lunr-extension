= Antora Lunr Extension
:url-antora-docs: https://docs.antora.org/antora/3.0
:url-antora-lunr: https://github.com/Mogztter/antora-lunr
:toc: preamble
:toc-title: Contents
ifdef::env-gitlab[:toclevels: 1]

https://lunrjs.com[Lunr] provides a great search experience without the need for external, server-side search services.
With this extension, you can add _offline_, full-text search powered by Lunr to your Antora documentation site.

NOTE: The Antora Lunr Extension is designed for and is compatible with {url-antora-docs}/whats-new/[Antora 3.0 and newer].
To integrate Lunr with an earlier version of Antora, you must use {url-antora-lunr}[antora-lunr] instead.

To add Lunr search to your Antora documentation site, you need to install the extension package, register the extension in your Antora playbook file, and add the search interface to the pages of your site.
Let's get started.

== Prerequisites

In order to use this extension, you must be using at least Node.js 16 and Antora 3.
We also assume you have configured an Antora playbook file (i.e., _antora-playbook.yml_) to build your site.

== Installation

Begin by installing the extension package into your {url-antora-docs}/playbook/use-an-existing-playbook-project/[playbook project]:

[,console]
----
$ npm i @antora/lunr-extension
----

You also have the option of installing the extension globally by adding the `-g` flag to the `npm i` command:

[,console]
----
$ npm i -g @antora/lunr-extension
----

However, we strongly recommend installing dependencies into the playbook project.
This strategy makes it easier to manage dependencies, documents those dependencies clearly, and keeps the dependencies of the current site isolated from others.

The previous two commands will download and install the latest release of this software from the npm registry.
If you want to use the development version, you can replace the name of the package with the URL of the git repository.

[,console]
----
$ npm i https://gitlab.com/antora/antora-lunr-extension
----

Although the software in the git repository is regularly and rigorously tested, the behavior of the development version may not always match the documentation.

== Usage

=== Register the extension

Now that you have the Lunr extension installed, you need to {url-antora-docs}/extend/register-extension/[register the extension] with Antora.
To register the extension, add an entry to the `antora.extensions` key in your {url-antora-docs}/playbook/[Antora playbook file].

Open the Antora playbook file and add the extension as follows:

.antora-playbook.yml
[,yaml]
----
antora:
  extensions:
  - require: '@antora/lunr-extension'
----

TIP: Alternately, you can register the extension when you run the `antora` command by using the `--extension` option.

=== Generate an index file

When you generate your documentation site the next time, the extension will automatically generate an index file at the root of your output directory.
The location of this file depends on the value of `output.dir` key in your playbook.
When using the {url-antora-docs}/playbook/configure-output/#default-output-dir[default output dir], that location is _build/site/search-index.js_.

=== Enable the search interface

Now that we have a search index (i.e., _search-index.js_), we need to enable the search component in the UI.

Copy the _supplemental_ui_ directory from the npm package at _node_modules/@antora/lunr-extension/supplemental_ui_ in your Antora playbook repository and configure the `ui.supplemental_files` key as follows:

.antora-playbook.yml
[,yaml]
----
ui:
  bundle:
    url: https://gitlab.com/antora/antora-ui-default/-/jobs/artifacts/HEAD/raw/build/ui-bundle.zip?job=bundle-stable
    snapshot: true
  supplemental_files: ./supplemental_ui
----

The `site.url` key does not have to be set in your playbook file in order for the search to work.
You can use the search even when viewing the site offline through a file URI.
In fact, you can set the site URL in the playbook to any allowable value and the search will work regardless.
(See the {url-antora-docs}/playbook/site-url/#url-key[site.url key] docs for details).
This works because the URLs in the search results are computed _relative to the current page_.
So they work regardless of where the site is deployed or on what page the search is used.

TIP: If you're using the https://www.npmjs.com/package/http-server[http-server] module to provide an HTTP server to view your site locally, you can set the `site.url` key to `+http://localhost:8080+` to emulate the conditions of a production environment.

=== Generate the site

If you have registered the extension in your playbook file, then you can generate your site using the `antora` command without having to pass any additional options or environment variables.

[,console]
----
$ antora antora-playbook.yml
----

If you have not registered the extension in your playbook file, you can register it using the `--extension` CLI option of the `antora` command:

[,console]
----
$ antora --extension @antora/lunr-extension antora-playbook.yml
----

Using the `--extension` option also allows you to enable the extension that's registered in the playbook file, but marked as not enabled using the `enabled` key.
See {url-antora-docs}/extend/enable-extension/[Enable an Extension] for details about how that works.

== Configuration

NOTE: In {url-antora-lunr}[antora-lunr] (the predecessor of this extension), configuration was performed using environment variables.
In this extension, configuration is now done using configuration keys in the playbook.

=== Index only the latest version

To index only the latest (i.e., released) version, set the `index_latest_only` configuration key:

.antora-playbook.yml
[,yaml]
----
antora:
  extensions:
  - require: '@antora/lunr-extension'
    index_latest_only: true
----

By default the extension indexes all the versions of your documentation components.

=== Support for other languages

By default, Lunr only supports English as an indexing language.
You can add support for the following other languages:

* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/IQ.png[ar] Arabic (ar)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/CN.png[zh] Chinese (zh) (see note below)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/DK.png[da] Danish (da)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/NL.png[nl] Dutch (nl)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/FI.png[fi] Finnish (fi)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/FR.png[fr] French (fr)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/DE.png[de] German (de)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/IN.png[hi] Hindi (hi)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/HU.png[hu] Hungarian (hu)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/IT.png[it] Italian (it)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/JP.png[ja] Japanese (ja)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/NO.png[no] Norwegian (no)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/PT.png[pt] Portuguese (pt)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/RO.png[ro] Romanian (ro)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/RU.png[ru] Russian (ru)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/ES.png[es] Spanish (es)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/SE.png[sv] Swedish (sv)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/TH.png[th] Thai (th)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/TR.png[tr] Turkish (tr)
* image:https://cdn.jsdelivr.net/gh/madebybowtie/FlagKit/Assets/PNG/VN.png[vi] Vietnamese (vi)

NOTE: To use Chinese as your language, you must install the `nodejieba` dependency (i.e., `npm i nodejieba`).

To use one or more languages, set the `languages` configuration key with all the desired language codes as a list:

.antora-playbook.yml
[,yaml]
----
antora:
  extensions:
  - require: '@antora/lunr-extension'
    languages: [en, fr]
----

== Run tests

This project is built using Node.js.
In order to run the tests, you need Node.js and the development dependencies for the project.

First, make sure you have at least Node.js installed.

[,console]
----
$ node -v
----

If you don't have Node.js, you can use https://github.com/nvm-sh/nvm[nvm] to install and manage it.

Once you have Node.js installed, run the following command to install the development dependencies:

[,console]
----
$ npm i
----

Now that you have the necessary prerequisites, you can run the tests using the following command:

[,console]
----
$ npm test
----

This command will use Mocha to run all the tests in the _tests/_ folder.

Before submitting any merge request, please run the following scripts to ensure the code is properly formatted:

[,console]
----
$ npm run lint && npm run format
----

If either of these scripts fail, the build will fail.
However, you need not worry about running them until you are ready to submit your change.

== Who's using it?

Here's a list of projects using the Antora Lunr extension.

* https://documentation.suse.com/external-tree/en-us/suma/4.0/suse-manager/[SUSE Manager Documentation]
* https://www.uyuni-project.org/uyuni-docs/[Uyuni Documentation]
* https://source.whitehatsec.com/help/sentinel/[NTT Application Security]
* https://hub.syn.tools/hub/[Commodore Components Hub (VSHN)]

To add your project to this list, please https://gitlab.com/antora/antora-lunr-extension/-/edit/main/README.adoc[edit this file]!
